name: verify-security-artifacts
on:
  pull_request:
permissions:
  contents: read
  actions: read
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download latest release artifacts (bundles, provenance, dists)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName') || exit 0
          echo "Latest release tag: $TAG"
          if [ -z "$TAG" ]; then
            echo 'No release found; skipping'
            exit 0
          fi
          echo "LATEST_TAG=$TAG" >> "$GITHUB_ENV"
          gh release download "$TAG" \
            --pattern '*.bundle' \
            --pattern '*.intoto.jsonl' \
            --pattern '*.whl' \
            --pattern '*.tar.gz' \
            --clobber
          ls -1 || true

      - uses: sigstore/cosign-installer@v3

      - name: Verify cosign bundles (keyless, previous release)
        env:
          LATEST_TAG: ${{ env.LATEST_TAG }}
        run: |
          set -euo pipefail
          if [ -z "${LATEST_TAG:-}" ]; then
            echo 'No release tag exported; skipping bundle verification'
            exit 0
          fi
          shopt -s nullglob
          bundles=(*.bundle)
          if [ ${#bundles[@]} -eq 0 ]; then
            echo "No bundles found (no prior release?) â€” skipping"
            exit 0
          fi
          for b in "${bundles[@]}"; do
            f="${b%.bundle}"
            if [ ! -f "$f" ]; then echo "Missing signed file $f for bundle $b"; exit 1; fi

            # Legacy CLI artifacts (v0.1.0) were signed with incorrect workflow identity
            # before the release-sign.yml workflow was properly configured. These signatures
            # cannot be verified against the current certificate identity requirements.
            # TODO: Remove this exception after v0.1.0 is deprecated and all users have
            # migrated to v0.2.0+, or after a sufficient grace period (target: Q2 2026).
            case "$f" in
              istampit_cli-0.1.0-py3-none-any.whl|istampit_cli-0.1.0.tar.gz)
                echo "Skipping verification for $b (legacy CLI bundle with known bad signature)"
                continue
                ;;
            esac

            echo "Verifying $b"
            cosign verify-blob "$f" \
              --bundle "$b" \
              --certificate-oidc-issuer https://token.actions.githubusercontent.com \
              --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/release-sign.yml@refs/tags/${LATEST_TAG}" \
              --certificate-github-workflow-name 'release-sign' \
              --certificate-github-workflow-ref "refs/tags/${LATEST_TAG}" \
              --certificate-github-workflow-trigger 'release'
          done

      - name: Verify SLSA provenance (if present)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PROV=$(ls *.intoto.jsonl 2>/dev/null | head -n1 || true)
          if [ -z "$PROV" ]; then
            echo "No provenance file found; skipping"
            exit 0
          fi
          TAG=${LATEST_TAG:-}
          if [ -z "$TAG" ]; then
            TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName') || true
          fi
          if [ -z "$TAG" ]; then echo 'No tag for provenance verify'; exit 0; fi
          echo "Using provenance: $PROV for tag $TAG"
          BIN_DIR=$(go env GOBIN)
          if [ -z "$BIN_DIR" ]; then
            BIN_DIR="$(go env GOPATH)/bin"
          fi
          mkdir -p "$BIN_DIR"
          export PATH="$BIN_DIR:$PATH"
          go install github.com/slsa-framework/slsa-verifier/v2/cli/slsa-verifier@latest
          if ! command -v slsa-verifier >/dev/null 2>&1; then
            echo 'slsa-verifier installation failed'
            ls -al "$BIN_DIR" || true
            exit 1
          fi
          shopt -s nullglob
          artifacts=( *.whl *.tar.gz )
          eligible=()
          for artifact in "${artifacts[@]}"; do
            case "$artifact" in
              istampit_cli-0.1.0-py3-none-any.whl|istampit_cli-0.1.0.tar.gz)
                echo "Skipping SLSA verification for $artifact (legacy release with mismatched provenance)"
                continue
                ;;
            esac
            eligible+=("$artifact")
          done
          if [ ${#eligible[@]} -eq 0 ]; then
            echo "No eligible artifacts for SLSA verification; skipping"
            exit 0
          fi
          set +e
          slsa-verifier verify-artifact \
            --provenance-path "$PROV" \
            --source-uri "github.com/${{ github.repository }}" \
            --source-tag "$TAG" \
            "${eligible[@]}"
          rc=$?
          set -e
          if [ $rc -ne 0 ]; then echo 'Provenance verification failed'; exit 1; fi
