name: lockfile-check
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  ensure-single-lockfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect stray lockfiles
        run: |
          set -euo pipefail
          echo "Scanning for extra package-lock.json files..."
          mapfile -t LOCKS < <(git ls-files "**/package-lock.json")
          ROOT_ONLY=0
          if [ "${#LOCKS[@]}" -eq 0 ]; then
            echo "ERROR: No package-lock.json found (expected root lockfile)" >&2
            exit 1
          fi
          for f in "${LOCKS[@]}"; do
            if [ "$f" != "package-lock.json" ]; then
              echo "Found disallowed lockfile: $f" >&2
              ROOT_ONLY=1
            fi
          done
          if [ $ROOT_ONLY -ne 0 ]; then
            echo "Failing due to disallowed lockfiles above root. Keep only a single root package-lock.json." >&2
            exit 2
          fi
          echo "Lockfile check passed (single root package-lock.json)."
