name: lockfile-check
on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  ensure-single-lockfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Detect stray lockfiles
        run: |
          set -euo pipefail
          echo "Scanning for extra package-lock.json files..."
          ROOT_LOCK=package-lock.json
          if [ ! -f "$ROOT_LOCK" ]; then
            echo "ERROR: Root package-lock.json missing" >&2
            ls -al
            exit 1
          fi
          # Find any nested lockfiles excluding node_modules
          NESTED=$(find . -type f -name package-lock.json -not -path './package-lock.json' -not -path '*/node_modules/*' || true)
          if [ -n "$NESTED" ]; then
            echo "Found disallowed nested lockfiles:" >&2
            echo "$NESTED" >&2
            exit 2
          fi
          echo "Lockfile check passed (single root package-lock.json)."
