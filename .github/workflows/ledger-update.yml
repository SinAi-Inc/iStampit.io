name: Update Ledger Status

on:
  schedule:
    # Run every 6 hours to check for Bitcoin confirmations
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

jobs:
  update-ledger:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.2.0
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: istampit-web/package-lock.json

      - name: Install dependencies
        working-directory: istampit-web
        run: npm ci

      - name: Build ledger updater
        working-directory: istampit-web
        run: npm run build

      - name: Run ledger update check
        working-directory: istampit-web
        run: |
          # Call the API endpoint to update ledger
          # In production, this would be a real HTTP call or direct script execution
          echo "Ledger update triggered"
          echo "Checking pending entries for Bitcoin confirmations..."
          # For now, this is a placeholder for the actual update logic
          # Real implementation would:
          # 1. Call /api/ledger/update endpoint
          # 2. Or run a Node script that updates ledger.json
          # 3. Commit changes if any entries were confirmed

      - name: Display results
        run: |
          echo "âœ… Ledger update check completed"
          echo "Pending entries will be automatically confirmed when Bitcoin blocks arrive"
