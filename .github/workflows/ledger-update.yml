name: Update Ledger Status

on:
  schedule:
    # Run every 6 hours to check for Bitcoin confirmations
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

jobs:
  update-ledger:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@633bb92bc0aabcae06e8ea93b85aecddd374c402 # v4.2.0
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --workspaces

      - name: Validate and clean ledger
        run: |
          echo "ðŸ§¹ Validating ledger integrity..."
          node scripts/validate-ledger.js

          # Remove any backup .ots files that may have appeared
          find istampit-web/public -name "*.ots.bak*" -type f -delete 2>/dev/null || true
          find istampit-web/public -name "*.ots.ots*" -type f -delete 2>/dev/null || true
          find istampit-web/public -name "*.ots.lost" -type f -delete 2>/dev/null || true
          echo "âœ… Ledger validated and backup files removed"

      - name: Check ledger status
        run: |
          echo "Checking pending OpenTimestamps entries for Bitcoin confirmations..."
          PENDING_COUNT=$(node -e "const fs=require('fs'); const ledger=JSON.parse(fs.readFileSync('ledger.json','utf8')); console.log(ledger.entries.filter(e=>e.status==='pending').length);")
          echo "Pending entries: $PENDING_COUNT"

          if [ "$PENDING_COUNT" -eq 0 ]; then
            echo "âœ… No pending entries to check"
            exit 0
          fi

          echo "Note: Automated confirmation checking requires blockchain API integration"
          echo "Pending timestamps will be confirmed once their Bitcoin blocks are mined"

      - name: Upgrade pending timestamps
        run: |
          echo "ðŸ”„ Attempting to upgrade pending timestamps..."
          node scripts/upgrade-pending-timestamps.js || true

          # Update ledger status after upgrades
          node scripts/update-ledger-status.js

      - name: Display results
        run: |
          echo "âœ… Ledger update check completed"
          echo "Current ledger statistics:"
          node -e "const fs=require('fs'); const ledger=JSON.parse(fs.readFileSync('ledger.json','utf8')); console.log('Total entries:', ledger.metadata.totalEntries); console.log('Confirmed:', ledger.metadata.confirmedEntries); console.log('Pending:', ledger.metadata.pendingEntries);"
