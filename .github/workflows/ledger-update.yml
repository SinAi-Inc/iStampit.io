name: Update Ledger Status

on:
  schedule:
    # Run every 6 hours to check for Bitcoin confirmations
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

jobs:
  update-ledger:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.2.0
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --workspaces

      - name: Check ledger status
        run: |
          echo "Checking pending OpenTimestamps entries for Bitcoin confirmations..."
          PENDING_COUNT=$(node -e "const fs=require('fs'); const ledger=JSON.parse(fs.readFileSync('ledger.json','utf8')); console.log(ledger.entries.filter(e=>e.status==='pending').length);")
          echo "Pending entries: $PENDING_COUNT"
          
          if [ "$PENDING_COUNT" -eq 0 ]; then
            echo "✅ No pending entries to check"
            exit 0
          fi
          
          echo "Note: Automated confirmation checking requires blockchain API integration"
          echo "Pending timestamps will be confirmed once their Bitcoin blocks are mined"

      - name: Display results
        run: |
          echo "✅ Ledger update check completed"
          echo "Current ledger statistics:"
          node -e "const fs=require('fs'); const ledger=JSON.parse(fs.readFileSync('ledger.json','utf8')); console.log('Total entries:', ledger.metadata.totalEntries); console.log('Confirmed:', ledger.metadata.confirmedEntries); console.log('Pending:', ledger.metadata.pendingEntries);"
